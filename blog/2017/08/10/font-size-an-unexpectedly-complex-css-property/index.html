
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Font-size: An Unexpectedly Complex CSS Property - In Pursuit of Laziness</title>
  <meta name="author" content="Manish Goregaokar">

  
  <meta name="description" content="font-size is the worst. It‚Äôs a CSS property probably everyone who writes CSS has used at some point. It‚Äôs pretty ubiquitous. And it‚Äôs super &hellip;">
  
  <!-- Tweaked https://harimenon.com/blog/2013/02/23/twitter-cards-for-octopress-blogs/ -->
  
      <meta property="twitter:card" content="summary">
      <meta property="twitter:site" content="Manishearth">
      <meta property="twitter:url" content="http://manishearth.github.io">
      <meta property="twitter:title" content="font-size: An unexpectedly complex CSS property">
      <meta property="twitter:description" content="font-size is the worst. It‚Äôs a CSS property probably everyone who writes CSS has used at some point. It‚Äôs pretty ubiquitous. And it‚Äôs super complicated. ‚ÄúBut it‚Äôs just a number‚Äù, you say. ‚ÄúHow can &hellip;">
      <meta name="twitter:image" content="http://manishearth.github.io/images/me.png" />
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://manishearth.github.io/blog/2017/08/10/font-size-an-unexpectedly-complex-css-property/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <link href="/stylesheets/custom.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <link href="/atom.xml" rel="alternate" title="In Pursuit of Laziness" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/javascripts/manish.js" type="text/javascript"></script>
  <!--- MathJax Configuration -->
  
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-62537162-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">In Pursuit of Laziness</a></h1>
  
    <h2>Manish Goregaokar's blog</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="manishearth.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Font-size: An Unexpectedly Complex CSS Property</h1>
    
    
      <p class="meta">
        





        
      </p>
    
  </header>


<div class="entry-content"><p><a href="https://developer.mozilla.org/en/docs/Web/CSS/font-size"><code>font-size</code></a> is the worst.</p>

<p>It‚Äôs a CSS property probably everyone who writes CSS has used at some point. It‚Äôs pretty ubiquitous.</p>

<p>And it‚Äôs <em>super</em> complicated.</p>

<p>‚ÄúBut it‚Äôs just a number‚Äù, you say. ‚ÄúHow can that be complicated?‚Äù</p>

<p>I too felt that way one time. And then I worked on implementing it for <a href="https://wiki.mozilla.org/Quantum/Stylo">stylo</a>.</p>

<p>Stylo is the project to integrate <a href="http://github.com/servo/servo/">Servo</a>‚Äôs styling system into Firefox. The styling system handles
parsing CSS, determining which rules apply to which elements, running this through the cascade,
and eventually computing and assigning styles to individual elements in the tree. This happens not
only on page load, but also whenever various kinds of events (including DOM manipulation) occur,
and is a nontrivial portion of pageload and interaction times.</p>

<p>Servo is in <a href="https://rust-lang.org">Rust</a>, and makes use of Rust‚Äôs safe parallelism in many places, one of them being
styling. Stylo has the potential to bring these speedups into Firefox, along with the added safety
of the code being in a safer systems language.</p>

<p>Anyway, as far as the styling system is concerned, I believe that font-size is the most complex
property it has to handle. Some properties may be more complicated when it comes to layout or
rendering, but font-size is probably the most complex one in the department of styling.</p>

<p>I‚Äôm hoping this post can give an idea of how complex the Web can <em>get</em>, and also serve as documentation
for some of these complexities. I‚Äôll also try to give an idea of how the styling system works throughout this post.</p>

<p>Alright. Let‚Äôs see what is so complex about font-size.</p>

<h2 id="the-basics">The basics</h2>

<p>The syntax of the property is pretty straightforward. You can specify it as:</p>

<ul>
  <li>A length (<code>12px</code>, <code>15pt</code>, <code>13em</code>, <code>4in</code>, <code>8rem</code>)</li>
  <li>A percentage (<code>50%</code>)</li>
  <li>A compound of the above, via a calc (<code>calc(12px + 4em + 20%)</code>)</li>
  <li>An absolute keyword (<code>medium</code>, <code>small</code>, <code>large</code>, <code>x-large</code>, etc)</li>
  <li>A relative keyword (<code>larger</code>, <code>smaller</code>)</li>
</ul>

<p>The first three are common amongst quite a few length-related properties. Nothing abnormal in the syntax.</p>

<p>The next two are interesting. Essentially, the absolute keywords map to various pixel values, and match
the result of <code>&lt;font size=foo&gt;</code> (e.g. <code>size=3</code> is the same as <code>font-size: medium</code>). The <em>actual</em> value they map to
is not straightforward, and I‚Äôll get to that later in this post.</p>

<p>The relative keywords basically scale the size up or down. The mechanism of the scaling was also complex, however
this has changed. I‚Äôll get to that too.</p>

<h2 id="em-and-rem-units">em and rem units</h2>

<p>First up: <code>em</code> units. One of the things you can specify in <em>any</em> length-based CSS property is a value with an <code>em</code> or <code>rem</code>
unit.</p>

<p><code>5em</code> means ‚Äú5 times the <code>font-size</code> of the element this is applied to‚Äù. <code>5rem</code> means ‚Äú5 times the font-size of the root element‚Äù</p>

<p>The implications of this are that font-size needs to be computed before all the other properties (well, not quite, but we‚Äôll get to that!)
so that it is available during that time.</p>

<p>You can also use <code>em</code> units within <code>font-size</code> itself. In this case, it computed relative to the font-size of the <em>parent</em> element, since
you can‚Äôt use the font-size of the element to compute itself. (This is identical to using a percentage unit)</p>

<h2 id="minimum-font-size">Minimum font size</h2>

<p>Browsers let you set a ‚Äúminimum‚Äù font size in their preferences, and text will not be scaled below it. It‚Äôs useful for those with
trouble seeing small text.</p>

<p>However, this doesn‚Äôt affect properties which depend on font-size via <code>em</code> units. So if you‚Äôre using a minimum font size,
<code>&lt;div style="font-size: 1px; height: 1em; background-color: red"&gt;</code> will have a very tiny height (which you‚Äôll notice from the color),
but the text will be clamped to the minimum size.</p>

<p>What this effectively means is that you need to keep track of <em>two</em> separate computed font size values. There‚Äôs one value that
is used to actually determine the font size used for the text, and one value that is used whenever the style system needs to
know the font-size (e.g. to compute an <code>em</code> unit.)</p>

<p>This gets slightly more complicated when <a href="https://en.wikipedia.org/wiki/Ruby_character">ruby</a> is involved. In ideographic scripts (usually, Han
and Han-based scripts like Kanji or Hanja) it‚Äôs sometimes useful to have the pronunciation
of each character above it in a phonetic script, for the aid of readers without proficiency in that
script, and this is known as ‚Äúruby‚Äù (‚Äúfurigana‚Äù in Japanese). Because these scripts are ideographic,
it‚Äôs not uncommon for learners to know the pronunciation of a word but have no idea how to write it.
An example would be <ruby><rb>Êó•</rb><rt>„Å´</rt><rb>Êú¨</rb><rt>„Åª„Çì</rt></ruby>, which is Êó•Êú¨ (‚Äúnihon‚Äù,
i.e. ‚ÄúJapan‚Äù) in Kanji with ruby „Å´„Åª„Çì in the phonetic Hiragana script above it.</p>

<p>As you can probably see, the phonetic ruby text is in a smaller font size (usually 50% of the font
size of the main text<sup id="fnref:5" role="doc-noteref"><a href="#fn:5" class="footnote">1</a></sup>). The minimum font-size support <em>respects</em> this, and ensures that if the ruby
is supposed to be <code>50%</code> of the size of the text, the minimum font size for the ruby is <code>50%</code> of the
original minimum font size. This avoids clamped text from looking like <ruby><rb>Êó•</rb><rt style="font-size: 1em">„Å´</rt><rb>Êú¨</rb><rt style="font-size: 1em">„Åª„Çì</rt></ruby> (where both get set to
the same size), which is pretty ugly.</p>

<h2 id="text-zoom">Text zoom</h2>

<p>Firefox additionally lets you zoom text only when zooming. If you have trouble reading small things, it‚Äôs great to
be able to just blow up the text on the page without having the whole page get zoomed (which means you need to scroll
around a lot).</p>

<p>In this case, <code>em</code> units of other properties <em>do</em> get zoomed as well. After all, they‚Äôre supposed to be relative to the text‚Äôs font
size (and may have some relation to the text), so if that size has changed so should they.</p>

<p>(Of course, that argument could also apply to the min font size stuff. I don‚Äôt have an answer for why it doesn‚Äôt.)</p>

<p>This is actually pretty straightforward to implement. When computing absolute font sizes (including
keywords), zoom them if text zoom is on. For everything else continue as normal.</p>

<p>Text zoom is also disabled within <code>&lt;svg:text&gt;</code> elements, which leads to some trickiness here.</p>

<h2 id="interlude-how-the-style-system-works">Interlude: How the style system works</h2>

<p>Before I go ahead it‚Äôs probably worth giving a quick overview of how everything works.</p>

<p>The responsibiltiy of a style system is to take in CSS code and a DOM tree, and assign computed styles to each element.</p>

<p>There‚Äôs a distinction between ‚Äúspecified‚Äù and ‚Äúcomputed‚Äù here. ‚Äúspecified‚Äù styles are in the format
you specify in CSS, whereas computed styles are those that get attached to the elements, sent to
layout, and inherited from. A given specified style may compute to different values when applied to
different elements.</p>

<p>So while you can <em>specify</em> <code>width: 5em</code>, it will compute to something like <code>width: 80px</code>. Computed values are usually a
cleaned up form of the specified value.</p>

<p>The style system will first parse the CSS, producing a bunch of rules usually containing declarations (a declaration is like <code>width: 20%;</code>; i.e. a property name and a specified value)</p>

<p>It then goes through the tree in top-down order (this is parallelized in Stylo), figuring out which declarations <em>apply</em> to each element
and in which order ‚Äì some declarations have precedence over others. Then it will compute each relevant declaration against the element‚Äôs style (and parent style, among other bits of info),
and store this value in the element‚Äôs ‚Äúcomputed style‚Äù.</p>

<p>There are a bunch of optimizations that Gecko and Servo do here to avoid duplicated work<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">2</a></sup>. There‚Äôs a
bloom filter for quickly checking if deep descendent selectors apply to a subtree. There‚Äôs a ‚Äúrule
tree‚Äù that helps cache effort from determining applicable declarations. Computed styles are
reference counted and shared very often (since the default state is to inherit from the parent or
from the default style).</p>

<p>But ultimately, this is the gist of what happens.</p>

<h2 id="keyword-values">Keyword values</h2>

<p>Alright, this is where it gets complicated.</p>

<p>Remember when I said <code>font-size: medium</code> was a thing that mapped to a value?</p>

<p>So what does it map to?</p>

<p>Well, it turns out, it depends on the font family. For the following HTML:</p>

<pre><code class="language-html">&lt;span style="font: medium monospace"&gt;text&lt;/span&gt;
&lt;span style="font: medium sans-serif"&gt;text&lt;/span&gt;
</code></pre>

<p>you get (<a href="https://codepen.io/anon/pen/RZgxjw">codepen</a>)</p>

<div style="border: 1px solid black; display: inline-block; padding: 15px;">
<span style="font: medium monospace">text</span>
<span style="font: medium sans-serif">text</span>
</div>

<p>where the first one computes to a font-size of 13px, and the second one computes to a font-size of
16px. You can check this in the computed style pane of your devtools, or by using
<code>getComputedStyle()</code>.</p>

<p>I <em>think</em> the reason behind this is that monospace fonts tend to be wider, so the default font size (medium)
is scaled so that they have similar widths, and all other keyword font sizes get shifted as well. The final result is something like this:</p>

<p><img class="center" src="/images/post/font-size-table.png" width="600" /></p>

<p>Firefox and Servo have <a href="https://github.com/servo/servo/blob/d415617a5bbe65a73bd805808a7ac76f38a1861c/components/style/properties/longhand/font.mako.rs#L763-L774">a matrix</a> that helps derive the values for all the absolute
font-size keywords based on the ‚Äúbase size‚Äù (i.e. the computed of <code>font-size: medium</code>). Actually,
Firefox has <a href="http://searchfox.org/mozilla-central/rev/c329d562fb6c6218bdb79290faaf015467ef89e2/layout/style/nsRuleNode.cpp#3272-3341">three tables</a> to support some legacy use cases like quirks mode (Servo has
yet to add support for these tables). We query other parts of the browser for what the ‚Äúbase size‚Äù
is based on the language and font family.</p>

<p>Wait, but what does the language have to do with this anyway? How does the language impact font-size?</p>

<p>It turns out that the base size depends on the font family <em>and</em> the language, and you can configure this.</p>

<p>Both Firefox and Chrome (using an extension) actually let you tweak which fonts get used on a per-language basis,
<em>as well as the default (base) font-size</em>.</p>

<p>This is not as obscure as one might think. Default system fonts are often really ugly for non-Latin-
using scripts. I have a separate font installed that produces better-looking Devanagari ligatures.</p>

<p>Similarly, some scripts are just more intricate than Latin. My default font size for Devanagari is
set to 18 instead of 16. I‚Äôve started learning Mandarin and I‚Äôve set that font size to 18 as well. Hanzi glyphs
can get pretty complicated and I still struggle to learn (and later recognize) them. A larger font size is great for this.</p>

<p>Anyway, this doesn‚Äôt complicate things too much.  This does mean that the font family needs to be
computed before font-size, which already needs to be computed before most other properties. The
language, which can be set using a <code>lang</code> HTML attribute, is internally treated as a CSS property by
Firefox since it inherits, and it must be computed earlier as well.</p>

<p>Not too bad. So far.</p>

<p>Now here‚Äôs the kicker. This <em>dependence</em> on the language and family <em>inherits</em>.</p>

<p>Quick, what‚Äôs the font-size of the inner <code>div</code>?</p>

<pre><code class="language-html">&lt;div style="font-size: medium; font-family: sans-serif;"&gt; &lt;!-- base size 16 --&gt;
    font size is 16px
    &lt;div style="font-family: monospace"&gt; &lt;!-- base size 13 --&gt;
        font size is ??
    &lt;/div&gt;
&lt;/div&gt;
</code></pre>

<p>For a normal inherited CSS property<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote">3</a></sup>, if the parent has a computed value of <code>16px</code>,
and the child has no additional values specified, the child will inherit a value of <code>16px</code>.
<em>Where</em> the parent got that computed value from doesn‚Äôt matter.</p>

<p>Here, <code>font-size</code> ‚Äúinherits‚Äù a value of <code>13px</code>. You can see this below (<a href="https://codepen.io/anon/pen/MvorQQ">codepen</a>):</p>

<div style="border: 1px solid black; display: inline-block; padding: 15px;">
<div style="font-size: medium; font-family: sans-serif;"> <!-- base size 16 -->
    font size is 16px
    <div style="font-family: monospace"> <!-- base size 13 -->
        font size is ??
    </div>
</div>
</div>

<p>Basically, if the computed value originated from a keyword, whenever the font family or language
change, font-size is recomputed from the original keyword with the new font family and language.</p>

<p>The reason this exists is because otherwise the differing font sizes wouldn‚Äôt work anyway! The default font size
is <code>medium</code>, so basically the root element gets a <code>font-size: medium</code> and all elements inherit from it. If you change
to monospace or a different language in the document you need the font-size recomputed.</p>

<p>But it doesn‚Äôt stop here. This even inherits <em>through relative units</em> (Not in IE).</p>

<pre><code class="language-html">&lt;div style="font-size: medium; font-family: sans-serif;"&gt; &lt;!-- base size 16 --&gt;
    font size is 16px
    &lt;div style="font-size: 0.9em"&gt; &lt;!-- could also be font-size: 50%--&gt;
        font size is 14.4px (16 * 0.9)
        &lt;div style="font-family: monospace"&gt; &lt;!-- base size 13 --&gt;
            font size is 11.7px! (13 * 0.9)
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
</code></pre>

<p>(<a href="https://codepen.io/anon/pen/oewpER">codepen</a>)</p>

<div style="border: 1px solid black; display: inline-block; padding: 15px;">
<div style="font-size: medium; font-family: sans-serif;"> <!-- base size 16 -->
    font size is 16px
    <div style="font-size: 0.9em"> <!-- could also be font-size: 90%-->
        font size is 14.4px (16 * 0.9)
        <div style="font-family: monospace"> <!-- base size 13 -->
            font size is 11.7px! (13 * 0.9)
        </div>
    </div>
</div>
</div>

<p>So we‚Äôre actually inheriting a font-size of <code>0.9*medium</code> when we inherit from the second div, not <code>14.4px</code>.</p>

<p>Another way of looking at it is whenever the font family or language changes, you should recompute the font-size as if the language and family <em>were always that way</em> up the tree.</p>

<p>Firefox code uses both of these strategies. The original Gecko style system handles this by actually
going back to the top of the tree and recalculating the font size as if the language/family were
different. I suspect this is inefficient, but the rule tree seems to be involved in making this slightly
more efficient</p>

<p>Servo, on the other hand, stores some extra data on the side when computing stuff, data which gets copied over to the child element. It basically
stores the equivalent of saying ‚ÄúYes, this font was computed from a keyword. The keyword was <code>medium</code>, and after that we applied a factor of 0.9 to it.‚Äù<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote">4</a></sup></p>

<p>In both cases, this leads to a bunch of complexities in all the <em>other</em> font-size complexities, since they need to be carefully preserved through this.</p>

<p>In Servo, <em>most</em> of this gets handled <a href="https://github.com/servo/servo/blob/53c6f8ea8bf1002d0c99c067601fe070dcd6bcf1/components/style/properties/longhand/font.mako.rs#L964-L1061">via custom cascading functions for font-size</a>.</p>

<h2 id="largersmaller">Larger/smaller</h2>

<p>So I mentioned that <code>font-size: larger</code> and <code>smaller</code> scale the size, but didn‚Äôt mention by what fraction.</p>

<p>According <a href="https://drafts.csswg.org/css-fonts-3/#relative-size-value">to the spec</a>, if the font-size currently matches the value of an absolute keyword size (medium/large/etc),
you should pick the value of the next/previous keyword sizes respectively.</p>

<p>If it is <em>between</em> two, find the same point between the next/previous two sizes.</p>

<p>This, of course, must play well with the weird inheritance of keyword font sizes mentioned before. In Gecko‚Äôs model this isn‚Äôt too hard,
since Gecko recalculates things anyway. In Servo‚Äôs model we‚Äôd have to store a sequence of applications of <code>larger</code>/<code>smaller</code> and relative
units, instead of storing just a relative unit.</p>

<p>Additionally, when computing this during text-zoom, you have to unzoom before looking it up in the table, and then rezoom.</p>

<p>Overall, a bunch of complexity for not much gain ‚Äî turns out only Gecko actually followed the spec here! All other browser engines
used simple ratios here.</p>

<p>So my fix here <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1361550">was simply to remove this behavior from Gecko</a>. That simplified things.</p>

<h2 id="mathml">MathML</h2>

<p>Firefox and Safari support MathML, a markup language for math. It doesn‚Äôt get used much on the Web these days, but it exists.</p>

<p>MathML has its own complexities when it comes to font-size. Specifically, <code>scriptminsize</code>, <code>scriptlevel</code>, and <code>scriptsizemultiplier</code>.</p>

<p>For example, in MathML, the text in the numerator or denominator of a fraction or the text of a superscript is 0.71 times the size of the text outside of it. This is because
the default <code>scriptsizemultiplier</code> for MathML elements is 0.71, and these specific elements all get a default scriptlevel of <code>+1</code>.</p>

<p>Basically, <code>scriptlevel=+1</code> means ‚Äúmultiply the font size by <code>scriptsizemultiplier</code>‚Äù, and
<code>scriptlevel=-1</code> is for dividing. This can be specified via a <code>scriptlevel</code> HTML attribute on an <code>mstyle</code> element. You can
similarly tweak the (inherited) multiplier via the <code>scriptsizemultiplier</code> HTML attribute, and the minimum size via <code>scriptminsize</code>.</p>

<p>So, for example:</p>

<pre><code class="language-html">&lt;math&gt;&lt;msup&gt;
    &lt;mi&gt;text&lt;/mi&gt;
    &lt;mn&gt;small superscript&lt;/mn&gt;
&lt;/msup&gt;&lt;/math&gt;&lt;br&gt;
&lt;math&gt;
    text
    &lt;mstyle scriptlevel=+1&gt;
        small
        &lt;mstyle scriptlevel=+1&gt;
            smaller
            &lt;mstyle scriptlevel=-1&gt;
                small again
            &lt;/mstyle&gt;
        &lt;/mstyle&gt;
    &lt;/mstyle&gt;
&lt;/math&gt;
</code></pre>

<p>will show as (you will need Firefox to see the rendered version, Safari supports MathML too but the support isn‚Äôt as good):</p>

<div style="border: 1px solid black; display: inline-block; padding: 15px;">
<math><msup><mi>text</mi><mn>small superscript</mn></msup></math><br />
<math>text&lt;mstyle scriptlevel=+1&gt; small &lt;mstyle scriptlevel=+1&gt; smaller &lt;mstyle scriptlevel=-1&gt; small again &lt;/mstyle&gt;&lt;/mstyle&gt;&lt;/mstyle&gt;</math>
</div>

<p>(<a href="https://codepen.io/anon/pen/BdZJgR">codepen</a>)</p>

<p>So this isn‚Äôt as bad. It‚Äôs as if <code>scriptlevel</code> is a weird <code>em</code> unit. No biggie, we know how to deal with those already.</p>

<p>Except you also have <code>scriptminsize</code>. This lets you set the minimum font size <em>for changes caused by <code>scriptlevel</code></em>.</p>

<p>This means that <code>scriptminsize</code> will make sure <code>scriptlevel</code> never causes changes that make the font smaller than the min size,
but it will ignore cases where you deliberately specify an <code>em</code> unit or a pixel value.</p>

<p>There‚Äôs already a subtle bit of complexity introduced here, <code>scriptlevel</code> now becomes another thing
that tweaks how <code>font-size</code> inherits. Fortunately, in Firefox/Servo internally <code>scriptlevel</code> (as are
<code>scriptminsize</code> and <code>scriptsizemultiplier</code>) is also handled as a CSS property, which means that we
can use the same framework we used for font-family and language here ‚Äì compute the script
properties before font-size, and if <code>scriptlevel</code> is set, force-recalculate the font size even if
font-size itself was not set.</p>

<h3 id="interlude-early-and-late-computed-properties">Interlude: early and late computed properties</h3>

<p>In Servo the way we handle dependencies in properties is to have a set of ‚Äúearly‚Äù properties and a
set of ‚Äúlate‚Äù properties (which are allowed to depend on early properties). We iterate the
declarations twice, once looking for early properties, and once for late. However, now we have a
pretty intricate set of dependencies, where font-size must be calculated after language, font-family,
and the script properties, but before everything else that involves lengths. Additionally, font-family
has to be calculated after all the other early properties due to another font complexity I‚Äôm not covering here.</p>

<p>The way we handle this is to <a href="https://github.com/servo/servo/blob/53c6f8ea8bf1002d0c99c067601fe070dcd6bcf1/components/style/properties/properties.mako.rs#L3195-L3204">pull font-size and font-family</a> out during the early computation,
but not deal with them until <a href="https://github.com/servo/servo/blob/53c6f8ea8bf1002d0c99c067601fe070dcd6bcf1/components/style/properties/properties.mako.rs#L3211-L3327">after the early computation is done</a>.</p>

<p>At that stage we first <a href="https://github.com/servo/servo/blob/53c6f8ea8bf1002d0c99c067601fe070dcd6bcf1/components/style/properties/properties.mako.rs#L3219-L3233">handle the disabling of text-zoom</a>, and then handle <a href="https://github.com/servo/servo/blob/53c6f8ea8bf1002d0c99c067601fe070dcd6bcf1/components/style/properties/properties.mako.rs#L3235-L3277">the complexities of font-family</a>.</p>

<p>We then <a href="https://github.com/servo/servo/blob/53c6f8ea8bf1002d0c99c067601fe070dcd6bcf1/components/style/properties/properties.mako.rs#L3280-L3303">compute the font family</a>. If a font size was specified, we <a href="https://github.com/servo/servo/blob/53c6f8ea8bf1002d0c99c067601fe070dcd6bcf1/components/style/properties/properties.mako.rs#L3305-L3309">just compute that</a>. If it
was not, but a font family, lang, or scriptlevel was specified, we <a href="https://github.com/servo/servo/blob/53c6f8ea8bf1002d0c99c067601fe070dcd6bcf1/components/style/properties/properties.mako.rs#L3310-L3324">force compute as inherited</a>, which handles all the constraints.</p>

<h3 id="why-scriptminsize-gets-complicated">Why scriptminsize gets complicated</h3>

<p>Unlike with the other ‚Äúminimum font size‚Äù, using an <code>em</code> unit in any property will calculate the
length with the clamped value, not the ‚Äúif nothing had been clamped‚Äù value, when the font size has
been clamped with scriptminsize. So at first glance handling this seems straightforward; only
consider the script min size when deciding to scale because of scriptlevel.</p>

<p>As always, it‚Äôs not that simple üòÄ:</p>

<pre><code class="language-html">&lt;math&gt;
&lt;mstyle scriptminsize="10px" scriptsizemultiplier="0.75" style="font-size:20px"&gt;
    20px
    &lt;mstyle scriptlevel="+1"&gt;
        15px
        &lt;mstyle scriptlevel="+1"&gt;
            11.25px
                &lt;mstyle scriptlevel="+1"&gt;
                    would be 8.4375, but is clamped at 10px
                        &lt;mstyle scriptlevel="+1"&gt;
                            would be 6.328125, but is clamped at 10px
                                &lt;mstyle scriptlevel="-1"&gt;
                                    This is not 10px/0.75=13.3, rather it is still clamped at 10px
                                        &lt;mstyle scriptlevel="-1"&gt;
                                            This is not 10px/0.75=13.3, rather it is still clamped at 10px
                                            &lt;mstyle scriptlevel="-1"&gt;
                                                This is 11.25px again
                                                    &lt;mstyle scriptlevel="-1"&gt;
                                                        This is 15px again
                                                    &lt;/mstyle&gt;
                                            &lt;/mstyle&gt;
                                        &lt;/mstyle&gt;
                                &lt;/mstyle&gt;
                        &lt;/mstyle&gt;
                &lt;/mstyle&gt;
        &lt;/mstyle&gt;
    &lt;/mstyle&gt;
&lt;/mstyle&gt;
&lt;/math&gt;
</code></pre>

<p>(<a href="https://codepen.io/anon/pen/wqepjo">codepen</a>)</p>

<p>Basically, if you increase the level a bunch of times after hitting the min size, decreasing it by one should not immediately
compute <code>min size / multiplier</code>. That would make things asymmetric; something with a net script level of <code>+5</code> should
have the same size as something with a net script level of <code>+6 -1</code>, provided the multiplier hasn‚Äôt changed.</p>

<p>So what happens is that the script level is calculated against the font size <em>as if scriptminsize had never applied</em>,
and we only use that size if it is greater than the min size.</p>

<p>It‚Äôs not just a matter of keeping track of the script level at which clamping happened ‚Äì the multiplier could change
in the process and you need to keep track of that too. So this ends up in creating <em>yet another font-size value to inherit</em>.</p>

<p>To recap, we are now at <em>four</em> different notions of font size being inherited:</p>

<ul>
  <li>The main font size used by styling</li>
  <li>The ‚Äúactual‚Äù font size, i.e. the main font size but clamped by the min size</li>
  <li>(In servo only) The ‚Äúkeyword‚Äù size; i.e. the size stored as a keyword and ratio, if it was derived from a keyword</li>
  <li>The ‚Äúscript unconstrained‚Äù size; the font size as if scriptminsize never existed.</li>
</ul>

<p>Another complexity here is that the following should still work:</p>

<pre><code class="language-html">&lt;math&gt;
&lt;mstyle scriptminsize="10px" scriptsizemultiplier="0.75" style="font-size: 5px"&gt;
    5px
    &lt;mstyle scriptlevel="-1"&gt;
        6.666px
    &lt;/mstyle&gt;
&lt;/mstyle&gt;
&lt;/math&gt;
</code></pre>

<p>(<a href="https://codepen.io/anon/pen/prwpVd">codepen</a>)</p>

<p>Basically, if you were already below the scriptminsize, reducing the script level (to increase the font size) should not get clamped, since then you‚Äôd get something too large.</p>

<p>This basically means you only apply scriptminsize if you are applying the script level to a value <em>greater than</em> the script min size.</p>

<p>In Servo, all of the MathML handling culminates in <a href="https://github.com/servo/servo/blob/53c6f8ea8bf1002d0c99c067601fe070dcd6bcf1/components/style/properties/gecko.mako.rs#L2304-L2403">this wonderful function that is more comment than code</a>, and
some code in the functions near it.</p>

<hr />

<p>So there you have it. <code>font-size</code> is actually pretty complicated. A lot of the web platform has hidden complexities like this, and it‚Äôs always fun to encounter more of them.</p>

<p>(Perhaps less fun when I have to implement them üòÇ)</p>

<p><em>Thanks to mystor, mgattozzi, bstrie, and projektir for reviewing drafts of this post</em></p>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:5" role="doc-endnote">
      <p>Interestingly, in Firefox, this number is 50% for all ruby <em>except</em> for when the language is Taiwanese Mandarin (where it is 30%). This is because Taiwan uses a phonetic script called Bopomofo, and each Han glyph can be represented as a maximum of 3 Bopomofo letters. So it is possible to choose a reasonable minimum size such that the ruby never extends the size of the glyph below it. On the other hand, pinyin can be up to six letters, and Hiragana up to (I think) 5, and the corresponding ‚Äúno overflow‚Äù scaling will be too tiny. So fitting them on top of the glyph is not a consideration and instead we elect to have a larger font size for better readability. Additionally, Bopomofo ruby is often set on the side of the glyph instead of on top, and 30% works better there. (h/t @upsuper for pointing this out)¬†<a href="#fnref:5" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:1" role="doc-endnote">
      <p>Other browser engines have other optimizations, I‚Äôm just less familiar with them¬†<a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>Some properties are inherited, some are ‚Äúreset‚Äù. For example, <code>font-family</code> is inherited ‚Äî child elements inherit font family from the parent unless otherwise specified. However <code>transform</code> is not, if you transform an element that does not further transform the children.¬†<a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>This won‚Äôt handle <code>calc</code>s, which is something I need to fix. Fixing this is trivial, you store an absolute offset in addition to the ratio.¬†<a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>
</div>


  <footer>
    <p class="meta">
      
<span class="byline author vcard beforesep">Posted by <span class="fn">Manish Goregaokar</span></span>

      





      



<span class="categories aftersep">
  
    <a class='category' href='/blog/categories/css/'>css</a>, <a class='category' href='/blog/categories/html/'>html</a>, <a class='category' href='/blog/categories/programming/'>programming</a>, <a class='category' href='/blog/categories/web/'>web</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://manishearth.github.io/blog/2017/08/10/font-size-an-unexpectedly-complex-css-property/" data-via="Manishearth" data-counturl="http://manishearth.github.io/blog/2017/08/10/font-size-an-unexpectedly-complex-css-property/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2017/05/19/teaching-programming-proactive-vs-reactive/" title="Previous Post: Teaching programming: Proactive vs reactive">&laquo; Teaching programming: Proactive vs reactive</a>
      
      
        <a class="basic-alignment right" href="/blog/2017/12/24/undefined-vs-unsafe-in-rust/" title="Next Post: Undefined vs Unsafe in Rust">Undefined vs Unsafe in Rust &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
<h1> About Me </h1>
<div id="about">
    I'm a self-taught programmer with interests in programming languages, online communities, human languages, Rust, and physics, to name a few. <br><br>

    I'm currently on the Rust core team, and I work at Google on <a href="https://github.com/unicode-org/icu4x">ICU4X</a>.
</div>
<div id="doodads">
 <a href="http://twitter.com/Manishearth" style="white-space:normal">   <img style="border:none;box-shadow:none" src="/images/twitter.png" width="30px"></a>
 <a href="http://github.com/Manishearth" style="white-space:normal">   <img style="border:none;box-shadow:none"  src="/images/github.png" width="30px"></a>
</div>
</section>
<section>
<!-- <iframe scrolling="no" style="border: 0; height: 58px; width: 208px; overflow: hidden;" src="https://se-flair.appspot.com/751483b5-3bd0-467a-b3aa-f0bb8ac3887d/"></iframe> -->
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/10/09/on-voting-systems/">On Voting Systems</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/02/04/rust-governance-scaling-empathy/">Rust Governance: Scaling Empathy</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/09/11/converting-a-webgl-application-to-webvr/">Converting a WebGL Application to WebVR</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/08/26/why-i-enjoy-blogging/">Why I Enjoy Blogging</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/06/05/the-future-of-clippy-the-rust-linter/">The Future of Clippy</a>
      </li>
    
  </ul>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2021 - Manish Goregaokar - Licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY SA 4.0</a> - 
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
